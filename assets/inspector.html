<script>
  ;(function() {
    var config = window.whistleInspectorConfig;
    var activeItem;
    var isReady;
    var getActiveSession;
    var getSelectedSessionList;
    var activeListeners = [];
    var readyListeners = [];
    var isRequest;

    function checkReady(item) {
      return !item || item.lost || (isRequest ? item.requestTime : item.endTime);
    }

    window.__pushWhistle5b6af7b9884e1165SessionActive__ = function(item, isReq) {
      isRequest = isRequest || isReq;
      if (activeItem === item) {
        if (!isReady && checkReady(item)) {
          isReady = true;
          readyListeners.forEach(function(l) {
            l(activeItem);
          });
        }
        return;
      }
      isReady = checkReady(item);
      activeItem = item;
      activeListeners.forEach(function(l) {
        l(activeItem);
      });
      if (isReady) {
        isReady = true;
        readyListeners.forEach(function(l) {
          l(activeItem);
        });
      }
    };

    function getAddEventHandler(listeners, ready) {
      return function(l) {
        if (typeof l === 'function') {
          listeners.indexOf(l) === -1 && listeners.push(l);
          if (ready) {
            isReady = isReady || checkReady(activeItem);
            isReady && l(activeItem);
          } else {
            activeItem = getActiveSession();
            isReady = checkReady(activeItem);
            l(activeItem);
          }
        }
      };
    }

    function getRemoveEventListener(listeners) {
      return function(l) {
        var index = listeners.indexOf(l);
        index !== -1 && listeners.splice(index, 1);
      };
    }

    var toast = {};
    var whistleBridge = {
      config: config,
      toast: toast,
      addSessionActiveListener: getAddEventHandler(activeListeners),
      removeSessionActiveListener: getRemoveEventListener(activeListeners),
      addSessionReadyListener: getAddEventHandler(readyListeners, true),
      removeSessionReadyListener: getRemoveEventListener(readyListeners),
      removeSessionActiveListeners: function() {
        activeListeners = [];
      },
      removeSessionReadyListeners: function() {
        readyListeners = [];
      }
    };

    try {
      window.parent.onWhistleInspectorCustomTabReady(function(options) {
        Object.keys(options.msgBox).forEach(function(name) {
          toast[name] = options.msgBox[name];
        });
        getActiveSession = options.getActiveSession;
        getSelectedSessionList = options.getSelectedSessionList;
        whistleBridge.decodeBase64 = options.decodeBase64;
        whistleBridge.importSessions = options.importSessions;
        whistleBridge.request = options.request;
        whistleBridge.createRequest = options.createRequest;
        whistleBridge.showModal = options.showModal;
        whistleBridge.getSelectedSessionList = getSelectedSessionList;
        whistleBridge.getActiveSession = whistleBridge.getSession = whistleBridge.getSelectedSession = getActiveSession;
        whistleBridge.importRules = options.importRules;
        whistleBridge.importValues = options.importValues;
        whistleBridge.getServerInfo = options.getServerInfo;
        whistleBridge.alert = options.alert;
        whistleBridge.confirm = options.confirm;
      });
    } catch (e) {}
    window.whistleBridge = whistleBridge;
  })();
</script>
